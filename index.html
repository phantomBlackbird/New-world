<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3D Action Game - Mobile Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-system@4.0.2/dist/aframe-physics-system.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* Mobile Controls Container */
        #mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Joystick Container */
        #movement-joystick {
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 60px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: relative;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        
        #joystick-handle {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 25px;
            position: absolute;
            top: 35px;
            left: 35px;
            transition: transform 0.1s;
        }
        
        /* Action Buttons Container */
        #action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        
        .action-btn {
            width: 70px;
            height: 70px;
            border-radius: 35px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .action-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }
        
        .action-btn.run {
            background: rgba(255, 165, 0, 0.6);
        }
        
        .action-btn.run.active {
            background: rgba(255, 165, 0, 0.9);
        }
        
        /* Camera Controls Hint */
        #camera-hint {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            z-index: 2000;
            transition: opacity 0.5s;
        }
        
        /* Crosshair */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            pointer-events: none;
            z-index: 500;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div>Loading Game...</div>
    </div>
    
    <!-- Crosshair -->
    <div id="crosshair"></div>
    
    <!-- Camera Control Hint -->
    <div id="camera-hint">üëÜ Swipe to look around</div>
    
    <!-- Mobile Controls -->
    <div id="mobile-controls">
        <!-- Movement Joystick -->
        <div id="movement-joystick">
            <div id="joystick-handle"></div>
        </div>
        
        <!-- Action Buttons -->
        <div id="action-buttons">
            <button class="action-btn" id="jump-btn" title="Jump">‚¨ÜÔ∏è</button>
            <button class="action-btn" id="shoot-btn" title="Shoot">üî´</button>
            <button class="action-btn" id="reload-btn" title="Reload">üîÑ</button>
            <button class="action-btn run" id="run-btn" title="Run/Sprint">‚ö°</button>
        </div>
    </div>

    <a-scene physics="debug: false; gravity: -9.8;" renderer="antialias: true; colorManagement: true; alpha: false;" vr-mode-ui="enabled: false">
        
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="world-model" src="Subrural.glb"></a-asset-item>
            <a-asset-item id="player-model" src="Player.glb"></a-asset-item>
            <a-asset-item id="ground-model" src="Ground.glb"></a-asset-item>
        </a-assets>

        <!-- World with collision -->
        <a-entity id="world" gltf-model="#world-model" static-body></a-entity>
        
        <!-- Ground with collision -->
        <a-entity id="ground" gltf-model="#ground-model" static-body position="0 0 0"></a-entity>

        <!-- Player Character with Animation System -->
        <a-entity id="player" 
                  gltf-model="#player-model" 
                  scale="0.0144 0.0144 0.0144"
                  position="0 1 5"
                  rotation="0 0 0"
                  animation-mixer="clip: 4; loop: repeat; crossFadeDuration: 0.2"
                  kinematic-body>
            
            <!-- Third-Person Camera Rig with Swipe Controls -->
            <a-entity id="camera-rig" position="0 2.5 6" rotation="0 0 0">
                <a-camera id="camera" active="true" wasd-controls="enabled: false" look-controls="enabled: false">
                    <a-cursor></a-cursor>
                </a-camera>
            </a-entity>
            
            <!-- Weapon Attachment Point -->
            <a-entity id="weapon-mount" position="0.5 1.2 0.8"></a-entity>
        </a-entity>

        <!-- Environment -->
        <a-sky color="#87CEEB"></a-sky>
        <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
        <a-light type="directional" color="#ffffff" intensity="0.8" position="10 20 10"></a-light>
    </a-scene>

    <script>
        // Mobile Touch Controller Component
        AFRAME.registerComponent('mobile-touch-controller', {
            init: function() {
                this.player = document.querySelector('#player');
                this.cameraRig = document.querySelector('#camera-rig');
                this.joystick = document.getElementById('movement-joystick');
                this.joystickHandle = document.getElementById('joystick-handle');
                
                // State management
                this.moveState = {
                    forward: false,
                    backward: false,
                    left: false,
                    right: false,
                    running: false
                };
                
                this.cameraRotation = { x: 15, y: 0 }; // Default camera angles
                this.joystickActive = false;
                this.joystickPosition = { x: 0, y: 0 };
                this.joystickMaxDistance = 35;
                
                // Touch event handlers
                this.setupTouchControls();
                
                // Hide loading screen after 2 seconds
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                    }, 500);
                }, 2000);
            },
            
            setupTouchControls: function() {
                // Joystick touch events
                this.joystick.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.joystickActive = true;
                    this.handleJoystickTouch(e.touches[0]);
                });
                
                this.joystick.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.joystickActive) {
                        this.handleJoystickTouch(e.touches[0]);
                    }
                });
                
                this.joystick.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.joystickActive = false;
                    this.resetJoystick();
                });
                
                // Camera swipe controls
                let lastTouchX = 0;
                let lastTouchY = 0;
                
                document.addEventListener('touchstart', (e) => {
                    // Only handle camera swipes if not touching joystick or buttons
                    if (!e.target.closest('#mobile-controls')) {
                        lastTouchX = e.touches[0].clientX;
                        lastTouchY = e.touches[0].clientY;
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (!e.target.closest('#mobile-controls') && lastTouchX !== 0) {
                        e.preventDefault();
                        
                        const deltaX = e.touches[0].clientX - lastTouchX;
                        const deltaY = e.touches[0].clientY - lastTouchY;
                        
                        // Update camera rotation
                        this.cameraRotation.y += deltaX * 0.5; // Horizontal rotation
                        this.cameraRotation.x -= deltaY * 0.3; // Vertical rotation (inverted for natural feel)
                        
                        // Clamp vertical rotation to prevent flipping
                        this.cameraRotation.x = Math.max(-30, Math.min(45, this.cameraRotation.x));
                        
                        // Apply rotation to camera rig
                        this.cameraRig.setAttribute('rotation', {
                            x: this.cameraRotation.x,
                            y: this.cameraRotation.y,
                            z: 0
                        });
                        
                        lastTouchX = e.touches[0].clientX;
                        lastTouchY = e.touches[0].clientY;
                    }
                });
                
                document.addEventListener('touchend', (e) => {
                    lastTouchX = 0;
                    lastTouchY = 0;
                });
                
                // Action buttons
                document.getElementById('jump-btn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.jump();
                });
                
                document.getElementById('shoot-btn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.shoot();
                });
                
                document.getElementById('reload-btn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.reload();
                });
                
                const runBtn = document.getElementById('run-btn');
                runBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.moveState.running = true;
                    runBtn.classList.add('active');
                    this.updateMovement();
                });
                
                runBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.moveState.running = false;
                    runBtn.classList.remove('active');
                    this.updateMovement();
                });
            },
            
            handleJoystickTouch: function(touch) {
                const rect = this.joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // Calculate distance from center
                let deltaX = touch.clientX - centerX;
                let deltaY = touch.clientY - centerY;
                
                // Limit distance
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                if (distance > this.joystickMaxDistance) {
                    deltaX = (deltaX / distance) * this.joystickMaxDistance;
                    deltaY = (deltaY / distance) * this.joystickMaxDistance;
                }
                
                // Update joystick handle position
                this.joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                
                // Calculate movement direction
                this.joystickPosition.x = deltaX / this.joystickMaxDistance;
                this.joystickPosition.y = deltaY / this.joystickMaxDistance;
                
                // Update movement state based on joystick position
                this.moveState.forward = this.joystickPosition.y < -0.2;
                this.moveState.backward = this.joystickPosition.y > 0.2;
                this.moveState.left = this.joystickPosition.x < -0.2;
                this.moveState.right = this.joystickPosition.x > 0.2;
                
                this.updateMovement();
            },
            
            resetJoystick: function() {
                this.joystickHandle.style.transform = 'translate(0px, 0px)';
                this.moveState.forward = false;
                this.moveState.backward = false;
                this.moveState.left = false;
                this.moveState.right = false;
                this.updateMovement();
            },
            
            updateMovement: function() {
                let animationId = 4; // Default idle/aiming
                
                if (this.moveState.forward) {
                    animationId = this.moveState.running ? 1 : 5; // Run/Walk forward
                    this.movePlayerRelative(0, 0, -0.1);
                } else if (this.moveState.backward) {
                    animationId = this.moveState.running ? 8 : 9; // Run/Walk backward
                    this.movePlayerRelative(0, 0, 0.1);
                } else if (this.moveState.right) {
                    animationId = this.moveState.running ? 3 : 7; // Run/Walk right
                    this.movePlayerRelative(0.1, 0, 0);
                } else if (this.moveState.left) {
                    animationId = this.moveState.running ? 6 : 10; // Run/Walk left
                    this.movePlayerRelative(-0.1, 0, 0);
                }
                
                this.playAnimation(animationId);
            },
            
            movePlayerRelative: function(x, z) {
                // Get camera rotation for forward/right vectors
                const cameraRotation = this.cameraRig.getAttribute('rotation');
                const angle = cameraRotation.y * Math.PI / 180;
                
                // Calculate movement relative to camera direction
                const cos = Math.cos(angle);
                const sin = Math.sin(angle);
                
                // Transform movement from camera space to world space
                const worldX = x * cos - z * sin;
                const worldZ = x * sin + z * cos;
                
                const currentPos = this.player.getAttribute('position');
                this.player.setAttribute('position', {
                    x: currentPos.x + worldX,
                    y: currentPos.y,
                    z: currentPos.z + worldZ
                });
            },
            
            playAnimation: function(clipId) {
                const player = this.player;
                const currentClip = player.getAttribute('animation-mixer').clip;
                
                if (currentClip != clipId) {
                    player.setAttribute('animation-mixer', {
                        clip: clipId,
                        loop: 'repeat',
                        crossFadeDuration: 0.2
                    });
                }
            },
            
            jump: function() {
                this.playAnimation(12); // Jump animation
                // Apply jump force (you'll need physics for actual jumping)
                setTimeout(() => {
                    if (!this.isMoving()) {
                        this.playAnimation(4);
                    }
                }, 500);
            },
            
            shoot: function() {
                const player = this.player;
                const previousClip = player.getAttribute('animation-mixer').clip;
                
                player.setAttribute('animation-mixer', {
                    clip: 14, // Shooting rifle
                    loop: 'once',
                    crossFadeDuration: 0.1
                });
                
                setTimeout(() => {
                    if (!this.isMoving()) {
                        this.playAnimation(4);
                    } else {
                        this.updateMovement();
                    }
                }, 300);
            },
            
            reload: function() {
                const player = this.player;
                const previousClip = player.getAttribute('animation-mixer').clip;
                
                player.setAttribute('animation-mixer', {
                    clip: 11, // Reloading
                    loop: 'once',
                    crossFadeDuration: 0.1
                });
                
                setTimeout(() => {
                    if (!this.isMoving()) {
                        this.playAnimation(4);
                    } else {
                        this.updateMovement();
                    }
                }, 800);
            },
            
            isMoving: function() {
                return this.moveState.forward || this.moveState.backward || 
                       this.moveState.left || this.moveState.right;
            }
        });

        // Collision Detection Component
        AFRAME.registerComponent('collision-detection', {
            init: function() {
                this.el.addEventListener('collide', (e) => {
                    // Handle collision with world objects
                    console.log('Collision detected');
                });
            }
        });

        // Initialize game when scene loads
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            
            scene.addEventListener('loaded', () => {
                console.log('Scene loaded');
                
                // Add mobile touch controller to scene
                scene.setAttribute('mobile-touch-controller', '');
                
                // Add collision detection to player
                const player = document.querySelector('#player');
                player.setAttribute('collision-detection', '');
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loading-screen').style.opacity = '0';
                }, 1000);
            });
        });

        // Prevent default touch behaviors on mobile
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('#mobile-controls')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('#mobile-controls')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
  </html>
